services:
  agent:
    build:
      context: .
      dockerfile: apps/agent/Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@host.docker.internal:5432/worldtester}
      GOOGLE_GENERATIVE_AI_API_KEY: ${GOOGLE_GENERATIVE_AI_API_KEY}
      HEADLESS: ${HEADLESS:-true}
      TARGET_URL: ${TARGET_URL:-}
      VNC: ${VNC:-false}
      AGENT_MODE: ${AGENT_MODE:-cli}
      AGENT_PORT: 3100
    ports:
      - "3100:3100"
      - "5900:5900"
      - "5901:5901"
    volumes:
      - ./data/screenshots:/app/data/screenshots
      - ./data/.browser-profile-docker:/app/data/.browser-profile
    stdin_open: true
    tty: true

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        WEB_PORT: ${WEB_PORT:-3000}
    environment:
      PORT: ${WEB_PORT:-3000}
      NEXT_PUBLIC_AGENT_WS_URL: ${NEXT_PUBLIC_AGENT_WS_URL:-ws://localhost:3100}
      NEXT_PUBLIC_VNC_WS_URL: ${NEXT_PUBLIC_VNC_WS_URL:-ws://localhost:5901}
      NEXT_PUBLIC_AGENT_HTTP_URL: ${NEXT_PUBLIC_AGENT_HTTP_URL:-http://localhost:3100}
    ports:
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"
    depends_on:
      - agent
